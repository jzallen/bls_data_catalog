version: 2

# REPORTS LAYER - Semantic Models
# These define on-demand aggregations that can be queried via MetricFlow
# Each semantic model becomes a "Report" that can be rendered as a BI component

semantic_models:
  # Report 1: State Employment Overview
  - name: state_employment_report
    description: "Employment metrics by state and time period"
    model: ref('state_employment_combined')
    
    meta:
      visualization_type: "table"
      component: "StateEmploymentTable"
      refresh_policy: "on_demand"
    
    defaults:
      agg_time_dimension: year_month
    
    # Primary entity (grain of the data)
    entities:
      - name: state
        type: primary
        expr: state_fips
      
      - name: region
        type: foreign
        expr: region_name
    
    # Dimensions (attributes for grouping/filtering)
    dimensions:
      - name: year_month
        type: time
        type_params:
          time_granularity: month
      
      - name: state_name
        type: categorical
        expr: state_name
      
      - name: state_abbr
        type: categorical
        expr: state_abbr
      
      - name: region_name
        type: categorical
        expr: region_name
      
      - name: division_name
        type: categorical
        expr: division_name
      
      - name: year
        type: categorical
        expr: year
      
      - name: quarter
        type: categorical
        expr: year_quarter
    
    # Measures (metrics that can be aggregated)
    measures:
      - name: total_employment
        description: "Total employment level"
        agg: sum
        expr: employment_count
      
      - name: total_unemployed
        description: "Total unemployed persons"
        agg: sum
        expr: unemployed_count
      
      - name: total_labor_force
        description: "Total labor force"
        agg: sum
        expr: labor_force_count
      
      - name: avg_unemployment_rate
        description: "Average unemployment rate"
        agg: average
        expr: unemployment_rate
      
      - name: state_count
        description: "Number of states"
        agg: count_distinct
        expr: state_fips

  # Report 2: Regional Employment Trends
  - name: regional_employment_report
    description: "Regional aggregated employment metrics over time"
    model: ref('state_employment_combined')
    
    meta:
      visualization_type: "line_chart"
      component: "RegionalTrendChart"
      refresh_policy: "on_demand"
    
    defaults:
      agg_time_dimension: year_month
    
    entities:
      - name: region
        type: primary
        expr: region_name
    
    dimensions:
      - name: year_month
        type: time
        type_params:
          time_granularity: month
      
      - name: region_name
        type: categorical
        expr: region_name
      
      - name: year
        type: categorical
        expr: year
    
    measures:
      - name: regional_employment
        description: "Total regional employment"
        agg: sum
        expr: employment_count
      
      - name: regional_unemployment_rate
        description: "Regional weighted average unemployment rate"
        agg: average
        expr: unemployment_rate
      
      - name: regional_labor_force
        description: "Total regional labor force"
        agg: sum
        expr: labor_force_count

  # Report 3: Employment Growth Analysis
  - name: employment_growth_report
    description: "Year-over-year employment growth by state"
    model: ref('state_employment_combined')
    
    meta:
      visualization_type: "bar_chart"
      component: "EmploymentGrowthChart"
      refresh_policy: "on_demand"
    
    defaults:
      agg_time_dimension: year_month
    
    entities:
      - name: state
        type: primary
        expr: state_fips
    
    dimensions:
      - name: year_month
        type: time
        type_params:
          time_granularity: month
      
      - name: state_name
        type: categorical
        expr: state_name
      
      - name: region_name
        type: categorical
        expr: region_name
    
    measures:
      - name: employment_level
        description: "Employment level for growth calculations"
        agg: sum
        expr: employment_count

  # Report 4: Unemployment Rate Distribution
  - name: unemployment_distribution_report
    description: "Distribution of unemployment rates across states"
    model: ref('state_employment_combined')
    
    meta:
      visualization_type: "histogram"
      component: "UnemploymentDistributionChart"
      refresh_policy: "on_demand"
    
    defaults:
      agg_time_dimension: year_month
    
    entities:
      - name: state
        type: primary
        expr: state_fips
    
    dimensions:
      - name: year_month
        type: time
        type_params:
          time_granularity: month
      
      - name: state_name
        type: categorical
        expr: state_name
      
      - name: unemployment_rate
        type: categorical
        expr: |
          case 
            when unemployment_rate < 3.0 then 'Very Low (< 3%)'
            when unemployment_rate < 4.0 then 'Low (3-4%)'
            when unemployment_rate < 5.0 then 'Moderate (4-5%)'
            when unemployment_rate < 6.0 then 'Elevated (5-6%)'
            else 'High (> 6%)'
          end
    
    measures:
      - name: state_count
        description: "Number of states in each unemployment bracket"
        agg: count_distinct
        expr: state_fips
      
      - name: avg_rate
        description: "Average unemployment rate"
        agg: average
        expr: unemployment_rate

# Metrics that can be derived from semantic models
metrics:
  # Metric 1: National Employment Total
  - name: national_employment
    description: "Total national employment across all states"
    type: simple
    label: "National Employment"
    type_params:
      measure: total_employment
    meta:
      format: "number"
      unit: "persons"
  
  # Metric 2: National Unemployment Rate
  - name: national_unemployment_rate
    description: "Weighted national unemployment rate"
    type: ratio
    label: "National Unemployment Rate"
    type_params:
      numerator: total_unemployed
      denominator: total_labor_force
    meta:
      format: "percentage"
      decimal_places: 1
  
  # Metric 3: Employment Growth Rate
  - name: employment_growth_rate
    description: "Month-over-month employment growth rate"
    type: derived
    label: "Employment Growth Rate"
    type_params:
      expr: "(current_employment - prior_employment) / prior_employment * 100"
      metrics:
        - name: current_employment
          alias: employment_level
        - name: prior_employment
          alias: employment_level
          offset_window: 1 month
    meta:
      format: "percentage"
      decimal_places: 2
